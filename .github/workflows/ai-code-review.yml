name: AI Review & Rebase Merge

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    outputs:
      analysis_result: ${{ steps.evaluate.outputs.result }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Codacy Analysis
        id: codacy_scan
        continue-on-error: true
        uses: codacy/codacy-analysis-cli-action@v4
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          verbose: true

      - name: Evaluate Result
        id: evaluate
        run: |
          if [ "${{ steps.codacy_scan.outcome }}" = "success" ]; then
            echo "Codacyæ£€æŸ¥é€šè¿‡"
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "Codacyæ£€æŸ¥å‘ç°é—®é¢˜"
            echo "result=failure" >> $GITHUB_OUTPUT
          fi

  auto-merge:
    runs-on: ubuntu-latest
    needs: [analyze]
    # ä»…åœ¨Codacyåˆ†ææˆåŠŸæ—¶ï¼Œæ‰å°è¯•è‡ªåŠ¨åˆå¹¶
    if: needs.analyze.outputs.analysis_result == 'success'
    steps:
      - name: Auto Merge PR (using Rebase)
        id: merge_step
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const response = await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                merge_method: 'rebase'  # ä½¿ç”¨å˜åŸºåˆå¹¶ï¼Œä¿æŒä¸»çº¿æ•´æ´
              });
              console.log('âœ… PR å·²é€šè¿‡å˜åŸºåˆå¹¶ã€‚');
              return response;
            } catch (error) {
              // å¦‚æœåˆå¹¶å¤±è´¥ï¼ˆå¦‚å†²çªï¼‰ï¼Œå°†é”™è¯¯ä¿¡æ¯æ‰“å°åˆ°æ—¥å¿—ï¼Œå¹¶æŠ›å‡ºé”™è¯¯ä½¿æ­¥éª¤å¤±è´¥
              console.error('âŒ è‡ªåŠ¨åˆå¹¶å¤±è´¥ï¼ŒåŸå› ï¼š', error.message);
              throw error;
            }

  notify-and-handle-failure:
    runs-on: ubuntu-latest
    needs: [analyze, auto-merge]
    # æ ¸å¿ƒé€»è¾‘ï¼šå¦‚æœåˆ†æå¤±è´¥ æˆ– è‡ªåŠ¨åˆå¹¶å¤±è´¥ï¼Œåˆ™æ‰§è¡Œæ­¤ä»»åŠ¡å‘é€é‚®ä»¶
    if: needs.analyze.result == 'failure' || needs.auto-merge.result == 'failure'
    steps:
      - name: Send Failure Notification Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          to: ${{ github.event.pull_request.user.email }}
          from: GitHub Actions Bot <${{ secrets.MAIL_USERNAME }}>
          subject: |
            [é‡è¦] PR #${{ github.event.pull_request.number }} è‡ªåŠ¨å¤„ç†æœªå®Œæˆ
          html: true
          body: |
            <p>ä½ å¥½ <strong>${{ github.event.pull_request.user.login }}</strong>ï¼Œ</p>

            <p>ä½ çš„ Pull Request <a href="${{ github.event.pull_request.html_url }}"><strong>#${{ github.event.pull_request.number }}</strong></a> åœ¨è‡ªåŠ¨å¤„ç†è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œéœ€è¦ä½ æ£€æŸ¥å¤„ç†ã€‚</p>

            <p><strong>ğŸ“ è¯¦ç»†ä¿¡æ¯</strong><br>
            ä»“åº“ï¼š<code>${{ github.repository }}</code><br>
            PRæ ‡é¢˜ï¼š${{ github.event.pull_request.title }}</p>

            <p><strong>âš ï¸ å¯èƒ½çš„åŸå› åŠæ“ä½œæŒ‡å¼•ï¼š</strong></p>
            <ul>
            <li><strong>Codacy ä»£ç è´¨é‡æ£€æŸ¥æœªé€šè¿‡</strong>ï¼šè¯·æŸ¥çœ‹ PR é¡µé¢ä¸Šçš„ Codacy æ£€æŸ¥æŠ¥å‘Šï¼Œæ ¹æ®æç¤ºä¿®æ”¹ä»£ç ã€‚</li>
            <li><strong>å­˜åœ¨åˆå¹¶å†²çª</strong>ï¼šä½ çš„åˆ†æ”¯ä¸ä¸»åˆ†æ”¯ (<code>main</code>) å­˜åœ¨å†²çªï¼Œéœ€è¦ä½ æ‰‹åŠ¨è§£å†³ã€‚</li>
            </ul>

            <p>è¯·è®¿é—® <a href="${{ github.event.pull_request.html_url }}">PR é¡µé¢</a> æŸ¥çœ‹è¯¦ç»†çŠ¶æ€å¹¶å¤„ç†ã€‚å¤„ç†å®Œæˆåï¼Œé‡æ–°æ¨é€ä»£ç å³å¯è§¦å‘æ–°ä¸€è½®è‡ªåŠ¨åŒ–æ£€æŸ¥ã€‚</p>
            <hr>
            <p><em>æ­¤é‚®ä»¶ç”± GitHub Actions å·¥ä½œæµè‡ªåŠ¨å‘é€ï¼Œè¯·å‹¿ç›´æ¥å›å¤ã€‚</em></p>
          secure: true

  cleanup:
    runs-on: ubuntu-latest
    needs: [analyze, auto-merge]
    if: always()
    steps:
      - name: Delete Source Branch (if merged)
        # ä»…åœ¨PRè¢«åˆå¹¶åæ‰æ‰§è¡Œåˆ é™¤
        if: github.event.pull_request.merged == true
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${{ github.event.pull_request.head.ref }}`
              });
              console.log('âœ… æºåˆ†æ”¯å·²åˆ é™¤ã€‚');
            } catch (error) {
              console.log('â„¹ï¸ åˆ†æ”¯å¯èƒ½å·²è¢«åˆ é™¤: ' + error.message);
            }
